# 인스타그램 백엔드 시스템 아키텍처

## 초기

- Django, Postgres를 사용했다. AWS에 호스팅 되지 않은 단일 서버였다.
- 인스타그램 창업자는 말했다. "PMF가 가장 중요한데, 대부부분의 스타트업은 확장에 집중하느라 PMF를 찾지 못한다고"
- 그리고 인스타그램은 유저 5000만을 가질 때 까지 Django, Postgres 환경을 가져갔다.

## 레이턴시 숨기기

- 분명 빠르지 않았다. 하지만 빠른 것처럼 보이게 만들었다.
- 유저가 사진을 선택하고 글을 쓰고 있다가 업로드 버튼을 누른 경우 사진을 업로드 할 때 시간이 오래 걸린다.
- 하지만 인스타그램은 유저가 사진을 고르고 글을 쓰고 있을 때 사진을 미리 업로드 해놨다. 그래서 빠른 것 처럼 보였다.
- 사진을 바꾸거나 업로드를 취소하면 미리 업로드 해둔 사진을 삭제하도록 했다.

## 아키텍처 진화

- 인스타그램 오픈 1년만에 1400만 유저를 달성했다. 이 때 AWS 단일 서버에서 아키텍처 변경을 시도했다. 고작 3명의 엔지니어가.
- [Request -> AWS ALB -> 3 Nginx -> 25+ EC2] 요런 식으로 요청을 처리하도록 개선했다.
- Postgre는 적극적으로 샤딩해서 관리했다. 샤드 간 데이터 동기화는 Master/Slave 로 구분해서 동기화를 했다.
- Redis를 사용해서 메인 피드, 활동 기록, 세션 관리를 했다.
- Redis와 Postgres 데이터는 모두 AWS Elastic Block Store를 통해 백업됐다.
- Memcached를 사용해서 DB 쿼리와 결과를 캐시했다.
- 유저가 인스타그램 서버로 이미지를 전송하는 방식에서, 유저가 S3로 바로 이미지를 전송하도록 변경됐다. 다만 보안을 위해 서버에서 유저에게 보안 URL을 주면, 유저가 보안 URL을 통해 이미지를 S3로 전달한다.
- Munin, Pingdom, PagerDuty, Sentry를 사용해서 각 경우와 상황에 맞게 모니터링을 진행했다.

## 저스틴 비버 문제

- 저스틴 비버는 팔로워가 2.9억명이다. 너무 많다! (현재 기준)
- 그래서 비버가 게시글을 올릴 때마가 인스타그램 서버가 다운되거나 굉장히 느려지는 현상이 생겼다.
- 인스타그램이 좋아요 수를 계산하는 방식이 병목 지점이었다.
  - 기존 방식: Post 테이블과 Like 테이블이 있을 때, Post 1개에 Like가 쌓이면 Like 테이블에 <post_id, user_id> 와 같은 형식으로 데이터가 계속 쌓이게 된다. 모든 유저의 피드에 보고 있는 게시글의 좋아요 개수를 알려줘야 하기 때문에 count 쿼리를 수행해야 한다. 하지만 count 쿼리는 데이터가 많아질수록 느려진다.
  - 개선된 방식: Post 테이블에 like_count와 같은 컬럼을 추가해서 count만 숫자 1개로 관리한다. 그럼에도 누가 좋아요를 눌렀는지는 알아야 하기 때문에 Like 테이블은 유지한다. 하지만 Like 테이블에 count 쿼리를 날리는 대신 Post 테이블에 찾는 게시글의 like_count 값만 그냥 읽어오면 된다.

## 페이스북 인수 이후

- 크게 알려진 바는 없다.
- AWS에서 Meta 데이터 센터로 옮겨졌다.
- 현재는 분당 46000개의 게시글을 처리하고 있다.
- TAO라고 불리는 소셜 그래프 DB를 사용하고 있다. 매초 10억건 이상의 읽기와 수백만건의 쓰기를 처리할 수 있다.
- 내부적으로 사용하는 빠른 파이썬 인터프리터인 Cinder를 사용한다.

## 출처

https://youtu.be/V27XkmVPqYQ