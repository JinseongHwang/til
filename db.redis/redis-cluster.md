## 레디스 클러스터는 데이터 동기화를 어떻게 할까?

### 개념

Redis 클러스터는 sharding을 사용하여 데이터를 여러 노드에 분산하여 저장한다. 
각 노드는 특정 키 범위를 담당하고, 이 범위는 해시 슬롯(hash slot)이라는 개념으로 관리된다. 
Redis 클러스터는 총 16,384개의 해시 슬롯을 가지고 있고, 각 노드가 이러한 해시 슬롯의 일부를 담당한다.

### 장애 발생하면?

만약 노드 장애가 발생해 새로운 마스터가 슬레이브 노드에서 승격되거나 노드가 추가/삭제되면, 클러스터 리밸런싱이 일어난다. 
이때는 각 노드가 담당하는 해시 슬롯의 범위가 변경되거나 조정되며, 특정 노드에서 관리하던 데이터가 새로운 노드로 이전될 수 있다. 
이 경우에만 데이터를 다른 노드로 이동시키는 과정이 일어난다.

### 해시 슬롯은?

해시 슬롯(Hash Slot)은 Redis 클러스터에서 데이터를 분산 저장하기 위한 분할 단위이다. 
클러스터에 있는 각 키는 특정 해시 슬롯에 할당되고, 이 해시 슬롯을 담당하는 노드가 해당 키의 데이터를 저장하거나 관리한다. 
Redis 클러스터는 여러 노드에 데이터를 분산하여 저장하기 때문에, 해시 슬롯은 각 노드에 데이터를 효율적으로 분배하고 관리하는 중요한 개념이다.

### 해시 슬롯의 동작 원리

1. 해시 함수: Redis는 각 키에 대해 CRC16 해시 함수를 사용해 해시 값을 계산한다.
2. 해시 슬롯 할당: 이 해시 값(mod 연산)을 사용하여 총 16,384개의 해시 슬롯 중 하나에 해당 키를 할당합니다. 각 해시 슬롯은 특정 범위의 키를 담당하게 되며, 그 범위는 클러스터 노드들에 분배된다.
3. 노드와 해시 슬롯 매핑: 클러스터 내에서 여러 노드가 있고, 각 노드는 해시 슬롯의 일부분을 관리한다. 예를 들어, 3개의 노드가 있을 때 각 노드가 5,461개의 해시 슬롯을 담당할 수 있다. Redis 클러스터는 이러한 해시 슬롯에 따라 데이터를 각 노드에 자동으로 분배한다.

### 왜 하필 16,384개?

- 16,384개의 해시 슬롯을 사용하면 Redis 클러스터는 수십 개에서 수백 개의 노드를 효율적으로 분산할 수 있다. 각 노드에 수천 개의 슬롯을 할당함으로써 적당한 데이터 분산을 유지할 수 있다.
- 16,384개의 해시 슬롯은 너무 작지도, 크지도 않은 적당한 크기로, 적은 메모리 비용으로 충분한 분산 성능을 제공한다. 더 큰 해시 슬롯의 개수는 메모리 사용량이 증가할 수 있고, 너무 작은 경우에는 노드 간 데이터 불균형 문제가 발생할 수 있다.
  - 2^14 == 16,384
- Redis는 CRC16 해시 함수를 사용하여 해시 슬롯을 계산하는데, 이 함수는 16비트 크기의 해시 값을 생성한다. 이 값의 최대 범위는 0에서 65,535까지이므로, 16384는 2의 제곱수에 가까운 값으로 효율적인 모듈 연산(계산 복잡도를 낮춤)을 할 수 있는 적당한 크기이다. (비트 연산에 유리하다)
- 노드가 추가되거나 제거될 때, 해시 슬롯 단위로 데이터를 재분배한다. 16,384개의 슬롯을 사용하면 이 재분배 과정이 세밀하고 효율적으로 이루어질 수 있으며, 적은 양의 데이터 이동으로도 클러스터를 유연하게 확장하거나 축소할 수 있다.

### 데이터 샤딩과 복제

- 키의 범위에 따라 데이터가 저장되는 샤드가 결정된다. 샤드 내에서 Master-Slave 구조로 데이터를 복제하게 된다.
- 물론 이는 논리적인 의미이며, Master와 Slave는 서로 다른 물리 서버에 구성된다.
- Master와 Slave의 데이터 정합성은 비동기로 처리된다. (최종적 일관성 모델을 따른다)
  - 싱글 스레드로 동작하지만 이벤트 루프 기반 아키텍처를 사용하기 때문에 비동기적으로 네트워크 I/O 등을 처리할 수 있다.

![img](https://docs.aws.amazon.com/ko_kr/AmazonElastiCache/latest/dg/images/ElastiCache-Cluster-Redis.png)

- https://docs.aws.amazon.com/AmazonElastiCache/latest/dg/Clusters.html
- https://redis.io/docs/latest/operate/oss_and_stack/reference/cluster-spec/
- https://www.essential2189.dev/what-is-redis
- https://stackoverflow.com/questions/36203532/why-redis-cluster-only-have-16384-slots
